name: Build Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          TAG_NAME="${GITHUB_REF_NAME#refs/tags/}"
          VERSION="${TAG_NAME#v}"
          VERSION_CODE_CURRENT=$(grep '^versionCode=' module.prop | cut -d= -f2)
          VERSION_CODE=$((VERSION_CODE_CURRENT + 1))
          bash build-tools/set-version.sh "$VERSION" "$VERSION_CODE"

      - name: Ensure version matches tag
        run: |
          TAG_NAME="${GITHUB_REF_NAME#refs/tags/}"
          VERSION="${TAG_NAME#v}"
          module_version=$(grep '^version=' module.prop | cut -d= -f2)
          if [ "$module_version" != "$VERSION" ]; then
            echo "Version mismatch: tag $VERSION vs module.prop $module_version"
            exit 1
          fi

      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt zip

      - name: Verify changelog entry exists
        run: |
          TAG_NAME="${GITHUB_REF_NAME#refs/tags/}"
          VERSION="${TAG_NAME#v}"
          grep -q "^${VERSION}$" changelog.md

      - name: Run lint/format/test/package
        run: bash build-tools/run-all.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: magisk-samsung-dex-standalone-mode
          path: magisk-samsung-dex-standalone-mode.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: magisk-samsung-dex-standalone-mode.zip
